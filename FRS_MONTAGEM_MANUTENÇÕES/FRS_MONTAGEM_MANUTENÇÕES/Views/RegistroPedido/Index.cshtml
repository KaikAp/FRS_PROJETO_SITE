<div class="d-flex flex-column align-items-center semi-main">
    <form id="pedidoForm" class="formulario col-6 my-5">
        <h3 class="text-center my-5">CRIAR UM NOVO PEDIDO</h3>
        <h5 class="text-end mx-5 fs-6 mb-4">ID Pedido <span class="m-4 p-2" style="background-color: rgba(0, 0, 0, 0.112);">102.XXX.XXX</span></h5>
        <div class="inputs w-75 m-auto">
            <div class="my-3">
                <p class="ms-4 my-2">CNPJ:</p>
                <input type="text" id="cnpj" name="CNPJ" class="h-25 mb-2 px-3 py-2">
            </div>
            <div class="my-3">
                <p class="ms-4 my-2">Nome do Projeto:</p>
                <input type="text" id="nomePedido" name="Nome" class="h-25 mb-4 px-3 py-2">
            </div>
            <div class="my-3">
                <p class="ms-4 my-2">Descrição do Projeto:</p>
                <textarea rows="5" id="descricaoPedido" name="Descrição" class="h-75 mb-4 p-3"></textarea>
            </div>
            <div class="my-3" id="topicosContainer"></div>
            <div class="botoes col-12 mx-auto my-5 d-flex justify-content-around flex-wrap">
                <button class="cancelar fw-bold py-2 px-4" style="border: solid 0.7px #ffc846;">Cancelar</button>
                <button class="continuar fw-bold py-2 px-4 d-flex align-items-center justify-content-evenly" type="submit">
                    Continuar
                </button>
                <button type="button" class="continuar fw-bold py-2 px-4 mt-4 d-flex align-items-center justify-content-evenly btn-adicionar-topico">
                    Adicionar Tópico
                </button>
            </div>
        </div>
    </form>
    <script>
        // Seleciona o container onde os tópicos serão adicionados
        const topicosContainer = document.getElementById("topicosContainer");

        // Inicializa o contador de tópicos
        let topicoCount = 0;

        // Função para adicionar um novo tópico
        function adicionarTopico() {
            // Incrementa o contador de tópicos
            topicoCount++;

            // Cria o container do novo tópico
            const topicoDiv = document.createElement("div");
            topicoDiv.classList.add("my-3");

            // Cria o título do tópico
            const topicoLabel = document.createElement("p");
            topicoLabel.classList.add("ms-4", "my-2");
            topicoLabel.innerText = `Tópico ${topicoCount}:`;
            topicoDiv.appendChild(topicoLabel);

            // Cria o input do tópico
            const topicoInput = document.createElement("input");
            topicoInput.type = "text";
            topicoInput.name = `topico_${topicoCount}`;
            topicoInput.id = `topico_${topicoCount}`;
            topicoInput.classList.add("h-25", "mb-2", "px-3", "py-2", "w-100");
            topicoDiv.appendChild(topicoInput);

            // Container para os passos do tópico
            const passosContainer = document.createElement("div");
            passosContainer.classList.add("passos-container", "my-2");
            passosContainer.id = `passosContainer${topicoCount}`
            topicoDiv.appendChild(passosContainer);

            // Inicializa o contador de passos para o tópico atual
            let passoCount = 1;

            // Função para adicionar um passo ao tópico atual
            function adicionarPasso() {
                // Cria o título do passo
                const passoLabel = document.createElement("p");
                passoLabel.classList.add("ms-4", "my-2");
                passoLabel.innerText = `Passo ${topicoCount}.${passoCount}:`;
                passosContainer.appendChild(passoLabel);

                // Cria o input do passo
                const passoInput = document.createElement("input");
                passoInput.type = "text";
                passoInput.name = `passo_${passoCount}_${topicoCount}`;
                passoInput.id = `passo_${passoCount}_${topicoCount}`;
                passoInput.classList.add("h-25", "mb-4", "px-3", "py-2", "w-100");
                passosContainer.appendChild(passoInput);

                // Incrementa o contador de passos
                passoCount++;
            }

            // Adiciona o primeiro passo ao tópico
            adicionarPasso();

            // Cria o botão "Adicionar Passo" para o tópico atual
            const addPassoButton = document.createElement("button");
            addPassoButton.type = "button";
            addPassoButton.classList.add("my-2", "ms-4", "btn-adicionar-passo", "continuar");
            addPassoButton.innerText = "Adicionar Passo";

            // Adiciona evento de clique para o botão "Adicionar Passo"
            addPassoButton.addEventListener("click", (e) => {
                e.preventDefault();
                adicionarPasso(); // Chama a função para adicionar um passo ao tópico atual
            });

            // Adiciona o botão "Adicionar Passo" ao container do tópico
            topicoDiv.appendChild(addPassoButton);

            // Adiciona o container do novo tópico ao container principal
            topicosContainer.appendChild(topicoDiv);
        }

        // Adiciona o evento de clique ao botão "Adicionar Tópico"
        document.querySelector(".btn-adicionar-topico").addEventListener("click", (e) => {
            e.preventDefault(); // Evita o comportamento padrão do botão
            adicionarTopico(); // Chama a função para adicionar o tópico
        });


        document.getElementById("pedidoForm").addEventListener("submit", function (event) {
            event.preventDefault();

            // Captura dados principais do pedido
            const nomePedido = document.getElementById("nomePedido").value;
            const descricaoPedido = document.getElementById("descricaoPedido").value;

            // Cria array para armazenar os tópicos
            const topicos = [];
            for (let i = 1; i <= topicoCount; i++) {
                const topicoNome = document.getElementById(`topico_${i}`);
                if (topicoNome) {
                    const passos = [];
                    const passosContainer = document.getElementById(`passosContainer${i}`);
                    for (let j = 1; j <= passosContainer.childElementCount; j++) {
                        const passoNome = document.getElementById(`passo_${j}_${i}`);
                        if (passoNome) {
                            passos.push({ nome: passoNome.value });
                        }
                    }
                    topicos.push({
                        nome: topicoNome.value,
                        passos: passos
                    });
                }
            }

            // Monta o objeto PedidoData
            const pedidoData = {
                nomePedido: nomePedido,
                descricaoPedido: descricaoPedido,
                topicos: topicos
            };

            // Envia os dados para o backend com fetch
            fetch("/RegistroPedido/ReceberDados", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(pedidoData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Pedido enviado com sucesso!");
                    } else {
                        alert("Erro ao enviar o pedido.");
                    }
                })
                .catch(error => console.error("Erro:", error));
        });
    </script>
</div>